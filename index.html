<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" >
    <title>MEPs additional income - @sejm_watch</title>

    <link rel="icon" type="image/png" href="img/sw_logo_small_squared.png">

    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="js/viz.js"></script>

    <style>
      div.tooltip {
        position: absolute;
        text-align: center;
        width: 150px;
        height: 28px;
        padding: 2px;
        font: 12px sans-serif;
        background: #FFCC00;
        border: 0px;
        border-radius: 8px;
        pointer-events: none;
      }


      .label {
        position: absolute;
        top: 120px;
        left: 150px;
        display: inline-flex;
        align-items: center;
        cursor: pointer;
      }

      .label-text {
        margin-left: 8px;
      }

      .toggle {
        isolation: isolate;
        position: relative;
        height: 16px;
        width: 60px;
        border-radius: 16px;
        background: #FFCC00;
        overflow: hidden;
      }

      .toggle-inner {
        z-index: 2;
        position: absolute;
        top: 1px;
        left: 1px;
        height: 14px;
        width: 58px;
        border-radius: 14px;
        overflow: hidden;
      }

      .active-bg {
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        width: 200%;
        background: #6699ff;
        transform: translate3d(-100%, 0, 0);
        transition: transform 0.05s linear 0.17s;
      }

      .toggle-state {
        display: none;
      }

      .indicator {
        height: 100%;
        width: 200%;
        background: white;
        border-radius: 13px;
        transform: translate3d(-75%, 0, 0);
        transition: transform 0.35s cubic-bezier(0.85, 0.05, 0.18, 1.35);
      }

      .toggle-state:checked ~ .active-bg {
         transform: translate3d(-50%, 0, 0);
      }

      .toggle-state:checked ~ .toggle-inner .indicator {
         transform: translate3d(25%, 0, 0);
      }

    </style>
  </head>

  <body>
    <label class="label">
      <div class="toggle">
        <input class="toggle-state" type="checkbox" id="toggle-button" value="check" onclick="toggle_country_party_charts()" />
        <div class="toggle-inner">
           <div class="indicator"></div>
        </div>
        <div class="active-bg"></div>
      </div>
    </label>

    <script>
      var iso_lang_country = {
        "eu": 'Spain',
        "bg": 'Bulgaria',
        "ca": 'Spain',
        "hr": 'Croatia',
        "cs": 'Czechia',
        "da": 'Denmark',
        "nl": 'Netherlands',
        "nl-BE": 'Belgium',
        "en-IE": 'Ireland',
        "et": 'Estonia',
        "fi": 'Finland',
        "fr": 'France',
        "fr-BE": 'Belgium',
        "fr-LU": 'Luxembourg',
        "gd-IE": 'Ireland',
        "de": 'Germany',
        "de-AT": 'Austria',
        "de-LU": 'Luxembourg',
        "el": 'Greece',
        "hu": 'Hungary',
        "it": "Italy",
        "lv": "Latvia",
        "lt": "Lithuania",
        "pl": "Poland",
        "pt-BR": "Portugal",
        "pt": "Portugal",
        "ro": "Romania",
        "sk": "Slovakia",
        "sl": "Slovenia",
        "es": "Spain",
        "sv": "Sweden"
      }

      var user_lang = navigator.language || navigator.userLanguage;
      var user_country = iso_lang_country[user_lang] === undefined ? iso_lang_country[user_lang.split("-")[0]] : iso_lang_country[user_lang]
      console.log(user_country)
      console.log(window.screen.width)

      //tooltip
      var div_tooltip = d3.select("body").append("div")
          .attr("class", "tooltip")
          .style("opacity", 0);

      //svg & charts dimensions
      var svg_margin = {top: 10, right: 10, bottom: 10, left: 10},
          svg_width = 1600 - svg_margin.left - svg_margin.right,
          svg_height = 800 - svg_margin.top - svg_margin.bottom;

      var top_left_margin = {top: 80, right: 30, bottom: 10, left: 70},
          top_left_width = 450 - top_left_margin.left - top_left_margin.right,
          top_left_height = 600 - top_left_margin.top - top_left_margin.bottom;

      var top_middle_margin = {top: 80, right: 30, bottom: 10, left: 70},
          top_middle_width = 450 - top_middle_margin.left - top_middle_margin.right,
          top_middle_height = 600 - top_middle_margin.top - top_middle_margin.bottom;

      var top_right_margin = {top: 80, right: 30, bottom: 30, left: 100},
          top_right_width = 700 - top_right_margin.left - top_right_margin.right,
          top_right_height = 300 - top_right_margin.top - top_right_margin.bottom;

      var header_height = 60
      var header_width = 1600

      var country_income = [];
      var party_income = [];
      var category_income = [];

      d3.csv("data/declarations.csv").then(function(data) {
        //prepare data arrays for charts
        var deputies = [...new Set(data.map(x => x.deputy_name))];
        var eu_parties = [...new Set(data.map(x => x.eu_party_name))];
        var countries = [...new Set(data.map(x => x.country))];
        var organization_categories = [...new Set(data.map(x => x.organization_category))];
        organization_categories = organization_categories.filter(x => x != "");

        //single deputies income
        var deputies_income = [];
        deputies.forEach(function(dep){
            var dep_data = data.filter(x => x.deputy_name == dep);

            var dep_photo_url = dep_data[0].deputy_photo_url;
            var country = dep_data[0].country;
            var eu_party =  dep_data[0].eu_party_name;

            var dep_data = dep_data.filter(x => x.remuneration_type != "previous_occupations");
            var occupations_count = dep_data.length
            var paid_occupations_count = dep_data.filter(x => parseInt(x.salary_min) > 0).length;

            var salary_min = dep_data.map(x => parseInt(x.salary_min)).reduce((a, b) => a + b, 0);
            var salary_max = dep_data.map(x => parseInt(x.salary_max)).reduce((a, b) => a + b, 0);

            dep_obj = {
              'deputy_name': dep,
              'dep_photo_url': dep_photo_url,
              'country': country,
              'eu_party': eu_party,
              'occupations_count': occupations_count,
              'paid_occupations_count': paid_occupations_count,
              'salary_min': salary_min,
              'salary_max': salary_max
            };

            organization_categories.forEach(function(o){
              var dep_category_data = dep_data.filter(x => x.organization_category == o)
              var category_salary_min = dep_category_data.map(x => parseInt(x.salary_min)).reduce((a, b) => a + b, 0);
              var category_salary_max = dep_category_data.map(x => parseInt(x.salary_max)).reduce((a, b) => a + b, 0);
              dep_obj[o + "_salary_min"] = category_salary_min
              dep_obj[o + "_salary_max"] = category_salary_max
            });

            deputies_income.push(dep_obj)
        });
        deputies_income = deputies_income.sort((a,b) => (a.salary_max < b.salary_max) ? 1 : ((b.salary_max < a.salary_max) ? -1 : 0))
        //console.log(deputies_income)

        countries.forEach(function(c){
            var country_deputies = deputies_income.filter(x => x.country == c);

            var deputies_count = country_deputies.length;
            var deputies_additionally_paid = country_deputies.filter(x => parseInt(x.salary_min) > 0).length;
            var perc_deputies_additionally_paid = deputies_additionally_paid/deputies_count

            var occupations_count = country_deputies.map(x => parseInt(x.occupations_count)).reduce((a, b) => a + b, 0);
            var paid_occupations_count = country_deputies.map(x => parseInt(x.paid_occupations_count)).reduce((a, b) => a + b, 0);

            var avg_salary_min = country_deputies.map(x => parseInt(x.salary_min)).reduce((a, b) => a + b, 0)/deputies_count;
            var avg_salary_max = country_deputies.map(x => parseInt(x.salary_max)).reduce((a, b) => a + b, 0)/deputies_count;

            var median_salary_min = median(country_deputies.filter(x => parseInt(x.salary_min) > 0).map(x => parseInt(x.salary_min)))
            var median_salary_max = median(country_deputies.filter(x => parseInt(x.salary_min) > 0).map(x => parseInt(x.salary_max)))

            country_income.push({
              'country': c,
              'deputies_count': deputies_count,
              'deputies_additionally_paid': deputies_additionally_paid,
              'perc_deputies_additionally_paid': perc_deputies_additionally_paid,
              'occupations_count': occupations_count,
              'paid_occupations_count': paid_occupations_count,
              'avg_salary_min': avg_salary_min,
              'avg_salary_max': avg_salary_max,
              'median_salary_min': median_salary_min,
              'median_salary_max': median_salary_max
            })
        });
        country_income = country_income.sort((a,b) => (a.perc_deputies_additionally_paid < b.perc_deputies_additionally_paid) ? 1 : ((b.perc_deputies_additionally_paid < a.perc_deputies_additionally_paid) ? -1 : 0))
        //console.log(country_income)

        eu_parties.forEach(function(p){
            var party_deputies = deputies_income.filter(x => x.eu_party == p);

            var deputies_count = party_deputies.length;
            var deputies_additionally_paid = party_deputies.filter(x => parseInt(x.salary_min) > 0).length;
            var perc_deputies_additionally_paid = deputies_additionally_paid/deputies_count

            var occupations_count = party_deputies.map(x => parseInt(x.occupations_count)).reduce((a, b) => a + b, 0);
            var paid_occupations_count = party_deputies.map(x => parseInt(x.paid_occupations_count)).reduce((a, b) => a + b, 0);

            var avg_salary_min = party_deputies.map(x => parseInt(x.salary_min)).reduce((a, b) => a + b, 0)/deputies_count;
            var avg_salary_max = party_deputies.map(x => parseInt(x.salary_max)).reduce((a, b) => a + b, 0)/deputies_count;

            var median_salary_min = median(party_deputies.filter(x => parseInt(x.salary_min) > 0).map(x => parseInt(x.salary_min)))
            var median_salary_max = median(party_deputies.filter(x => parseInt(x.salary_min) > 0).map(x => parseInt(x.salary_max)))

            party_income.push({
              'eu_party': p,
              'deputies_count': deputies_count,
              'deputies_additionally_paid': deputies_additionally_paid,
              'perc_deputies_additionally_paid': perc_deputies_additionally_paid,
              'occupations_count': occupations_count,
              'paid_occupations_count': paid_occupations_count,
              'avg_salary_min': avg_salary_min,
              'avg_salary_max': avg_salary_max,
              'median_salary_min': median_salary_min,
              'median_salary_max': median_salary_max
            })
        });
        party_income = party_income.sort((a,b) => (a.perc_deputies_additionally_paid < b.perc_deputies_additionally_paid) ? 1 : ((b.perc_deputies_additionally_paid < a.perc_deputies_additionally_paid) ? -1 : 0))
        //console.log(party_income)


        organization_categories.forEach(function(o){
              var org_deputies = deputies_income.filter(x => x[o + "_salary_max"] != 0 && x.remuneration_type != "previous_occupations");

              var deputies_count = org_deputies.length;
              var deputies_additionally_paid = org_deputies.filter(x => parseInt(x.salary_min) > 0).length;
              var perc_deputies_additionally_paid = deputies_additionally_paid/deputies_count

              var occupations_count = org_deputies.map(x => parseInt(x.occupations_count)).reduce((a, b) => a + b, 0);
              var paid_occupations_count = org_deputies.map(x => parseInt(x.paid_occupations_count)).reduce((a, b) => a + b, 0);

              var total_salary_min = org_deputies.map(x => parseInt(x.salary_min)).reduce((a, b) => a + b, 0)
              var total_salary_max = org_deputies.map(x => parseInt(x.salary_max)).reduce((a, b) => a + b, 0)

              var avg_salary_min = org_deputies.map(x => parseInt(x.salary_min)).reduce((a, b) => a + b, 0)/deputies_count;
              var avg_salary_max = org_deputies.map(x => parseInt(x.salary_max)).reduce((a, b) => a + b, 0)/deputies_count;

              var median_salary_min = median(org_deputies.filter(x => parseInt(x.salary_min) > 0).map(x => parseInt(x.salary_min)))
              var median_salary_max = median(org_deputies.filter(x => parseInt(x.salary_min) > 0).map(x => parseInt(x.salary_max)))

              category_income.push({
                'organization_category': o,
                'deputies_count': deputies_count,
                'deputies_additionally_paid': deputies_additionally_paid,
                'perc_deputies_additionally_paid': perc_deputies_additionally_paid,
                'occupations_count': occupations_count,
                'paid_occupations_count': paid_occupations_count,
                'total_salary_min': total_salary_min,
                'total_salary_max': total_salary_max,
                'avg_salary_min': avg_salary_min,
                'avg_salary_max': avg_salary_max,
                'median_salary_min': median_salary_min,
                'median_salary_max': median_salary_max
              })
        });
        category_income = category_income.sort((a,b) => (a.total_salary_max < b.total_salary_max) ? 1 : ((b.total_salary_max < a.total_salary_max) ? -1 : 0))
        console.log(category_income)

        //##################################
        //svg container, header & footer
        //##################################
        var svg = d3.select("body").append("svg").attr("id","container")
          .attr("width", svg_width + svg_margin.left + svg_margin.right)
          .attr("height", svg_height + svg_margin.top + svg_margin.bottom)

        var header = svg.append("g").attr("id", 'header')
        header.append("text").attr("class", "title")
          .attr("x", 20)
          .attr("y", 30)
          .style("font-size", "36px").text("MEPs additional monthly income")

        header.append("text").attr("class", "subtitle")
          .attr("x", 20)
          .attr("y", 50)
          .style("font-size", "18px").text("Submitted income declarations, 2019-2021")

        header.append("line")
          .attr("x1", 0).attr("x2", header_width)
          .attr("y1", header_height).attr("y2", header_height)
          .attr("stroke", "#000000").attr("stroke-width", "1px")

        var footer = svg.append("g").attr("id", 'footer')
        footer.append("svg:image").attr("class","logotype")
          .attr("xlink:href", "img/sw_eye.png")
          .attr("x", 20)
          .attr("y", 760)
          .attr("height", 40)
        footer.append("text").attr("class", "subtitle")
          .attr("x", 160)
          .attr("y", 775)
          .style("font-size", "24px").style("font-weight", "bold").text("@sejm_watch")
          footer.append("text").attr("class", "subtitle")
            .attr("x", 166)
            .attr("y", 795)
            .style("font-size", "14px").text("twitter.com/sejm_watch")

        footer.append("line")
          .attr("x1", 0).attr("x2", header_width)
          .attr("y1", 750).attr("y2", 750)
          .attr("stroke", "#000000").attr("stroke-width", "1px")



        //##################################
        //building earnings % by country chart (top left)
        //##################################
        var top_left_heading = svg.append("g").attr("class", "section_heading")
        top_left_heading.append("text")
          .attr("x", top_left_margin.left)
          .attr("y", header_height + 35)
          .style("font-size", "18px").style("font-weight", "bold").text("% of MEPs declaring additional monthly income")

        var top_left_legend = svg.append("g").attr("class", "legend")
        top_left_legend.append("text").attr("id", "label_by_country")
          .attr("x", top_left_margin.left)
          .attr("y", header_height + 63)
          .style("fill", "#000000")
          .style("font-size", "14px").style("font-style", "italic").text("by country")
        top_left_legend.append("text").attr("id", "label_by_party")
          .attr("x", top_left_margin.left + 142)
          .attr("y", header_height + 63)
          .style("fill", "#AAAAAA")
          .style("font-size", "14px").style("font-style", "italic").text("by political party")

        var top_left_chart = svg.append("g")
            .attr("width", top_left_width + top_left_margin.left + top_left_margin.right)
            .attr("height", top_left_height + top_left_margin.top + top_left_margin.bottom)
          .append("g").attr("id", 'top_left_chart')
            .attr("transform", "translate(" + top_left_margin.left + "," + (header_height + top_left_margin.top) + ")");
        top_left_chart.append("g").attr("class", "y_axis")

        //Build chart
        draw_column_chart("#top_left_chart", div_tooltip, country_income, 'perc_deputies_additionally_paid', 'country', ['deputies_additionally_paid','deputies_count'], top_left_width, top_left_height)

        //##################################
        //building earnings median by country chart (top middle)
        //##################################
        var top_middle_heading = svg.append("g").attr("class", "section_heading")
        top_middle_heading.append("text")
          .attr("x", top_left_margin.left + top_left_width +  top_left_margin.right + top_middle_margin.left)
          .attr("y", header_height + 35)
          .style("font-size", "18px").style("font-weight", "bold").text("Median income (of those who declared any)")

        var top_middle_legend = svg.append("g").attr("class", "legend")
        top_middle_legend.append("text")
          .attr("x", top_left_margin.left + top_left_width +  top_left_margin.right + top_middle_margin.left)
          .attr("y", header_height + 53)
          .style("font-size", "12px").style("font-style", "italic").text("*MEPs declare financial interests categorizing ranges of income (from-to).")
        top_middle_legend.append("text")
          .attr("x", top_left_margin.left + top_left_width +  top_left_margin.right + top_middle_margin.left)
          .attr("y", header_height + 70)
          .style("font-size", "12px").style("font-style", "italic").text("The chart presents both minimal\u00A0\u00A0\u00A0\u00A0\u00A0and maximal\u00A0\u00A0\u00A0\u00A0\u00A0\u00A0\u00A0\u00A0declared income")

        top_middle_legend
          .append("circle")
            .attr("cx", top_left_margin.left + top_left_width +  top_left_margin.right + top_middle_margin.left + 164)
            .attr("cy", header_height + 66)
            .attr("r", "4")
            .style("fill", "#FFCC00").style("stroke", "#003399");
        top_middle_legend
          .append("circle")
            .attr("cx", top_left_margin.left + top_left_width +  top_left_margin.right + top_middle_margin.left + 246)
            .attr("cy", header_height + 66)
            .attr("r", "8")
            .style("fill", "#6699ff").style("stroke", "#003399");

        var top_middle_chart = svg.append("g")
            .attr("width", top_middle_width + top_middle_margin.left + top_middle_margin.right)
            .attr("height", top_middle_height + top_middle_margin.top + top_middle_margin.bottom)
          .append("g").attr("id", 'top_middle_chart')
            .attr("transform", "translate(" + (top_middle_margin.left + top_left_width + top_left_margin.left + top_left_margin.right) + "," + (header_height + top_middle_margin.top) + ")");
        top_middle_chart.append("g").attr("class", "y_axis")
        top_middle_chart.append("g").attr("class", "x_axis")
        //Build chart
        draw_cleveland_chart("#top_middle_chart", div_tooltip, country_income, 'median_salary_min', 'median_salary_max', 'country', ['median_salary_min', 'median_salary_max'], top_middle_width, top_middle_height)


        //##################################
        //building earnings top 10 deputies (top right)
        //##################################
        var top_right_heading = svg.append("g").attr("class", "section_heading")
        top_right_heading.append("text")
          .attr("x", top_right_margin.left + top_middle_width + top_middle_margin.left + top_middle_margin.right + top_left_width + top_left_margin.left + top_left_margin.right)
          .attr("y", header_height + 35)
          .style("font-size", "18px").style("font-weight", "bold").text("TOP10 MEPs additional monthly income")
          var top_right_legend = svg.append("g").attr("class", "legend")
          top_right_legend.append("text")
            .attr("x", top_right_margin.left + top_middle_width + top_middle_margin.left + top_middle_margin.right + top_left_width + top_left_margin.left + top_left_margin.right)
            .attr("y", header_height + 53)
            .style("font-size", "12px").style("font-style", "italic").text("*Maximal income presented, hoover photo to see income range.")
        var top_right_chart = svg.append("g")
            .attr("width", top_right_width + top_right_margin.left + top_right_margin.right)
            .attr("height", top_right_height + top_right_margin.top +top_right_margin.bottom)
          .append("g").attr("id", 'top_right_chart')
            .attr("transform", "translate(" + (top_right_margin.left + top_middle_width + top_middle_margin.left + top_middle_margin.right + top_left_width + top_left_margin.left + top_left_margin.right) + "," + (header_height + top_right_margin.top) + ")");
        top_right_chart.append("g").attr("class", "y_axis")
        top_right_chart.append("g").attr("class", "x_axis")

        //Build chart
        top_n_deputies = deputies_income.filter((d,idx) => idx < 10)
        draw_lollipop_chart("#top_right_chart", div_tooltip, top_n_deputies, 'deputy_name', 'salary_max', ['salary_min', 'salary_max'], top_right_width, top_right_height)


        //##################################
        //building earnings top 10 categories (bottom right)
        //##################################
        var bottom_right_heading = svg.append("g").attr("class", "section_heading")
        bottom_right_heading.append("text")
          .attr("x", top_right_margin.left + top_middle_width + top_middle_margin.left + top_middle_margin.right + top_left_width + top_left_margin.left + top_left_margin.right)
          .attr("y", header_height + top_right_height + top_right_margin.top + top_right_margin.bottom + 35)
          .style("font-size", "18px").style("font-weight", "bold").text("TOP10 sources of income - business areas")
          var bottom_right_legend = svg.append("g").attr("class", "legend")
          bottom_right_legend.append("text")
            .attr("x", top_right_margin.left + top_middle_width + top_middle_margin.left + top_middle_margin.right + top_left_width + top_left_margin.left + top_left_margin.right)
            .attr("y", header_height + top_right_height + top_right_margin.top + top_right_margin.bottom + 53)
            .style("font-size", "12px").style("font-style", "italic").text("*Maximal income presented, hoover photo to see income range.")
        var bottom_right_chart = svg.append("g")
            .attr("width", top_right_width + top_right_margin.left + top_right_margin.right)
            .attr("height", top_right_height + top_right_margin.top +top_right_margin.bottom)
          .append("g").attr("id", 'top_right_chart')
            .attr("transform", "translate(" + (top_right_margin.left + top_middle_width + top_middle_margin.left + top_middle_margin.right + top_left_width + top_left_margin.left + top_left_margin.right) + "," + (header_height + top_right_margin.top + top_right_height + top_right_margin.bottom + top_right_margin.top) + ")");
        bottom_right_chart.append("g").attr("class", "y_axis")
        bottom_right_chart.append("g").attr("class", "x_axis")

        //Build chart
        top_n_categories = category_income.filter((d) => d.organization_category != 'Unknown')
        top_n_categories = top_n_categories.filter((d,idx) => idx < 10)
        top_n_categories.push(top_n_categories.splice(top_n_categories.findIndex(function(e){return e.organization_category=='Other'}), 1)[0]);
        console.log(top_n_categories)
        //draw_horizontal_column_chart("#top_right_chart", div_tooltip, top_n_categories, 'organization_category', 'total_salary_max', ['total_salary_min', 'total_salary_max'], top_right_width, top_right_height)

      });
    </script>

  </body>
</html>
