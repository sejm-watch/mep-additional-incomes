<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="img/sw_logo_small_squared.png" >
    <script src="https://d3js.org/d3.v6.min.js"></script>

    <title>MEP side occupations</title>

    <style>
      div.tooltip {
        position: absolute;
        text-align: center;
        width: 90px;
        height: 28px;
        padding: 2px;
        font: 12px sans-serif;
        background: #FFCC00;
        border: 0px;
        border-radius: 8px;
        pointer-events: none;
      }
    </style>
  </head>

  <body>
    <script>
      var iso_lang_country = {
        "eu": 'Spain',
        "bg": 'Bulgaria',
        "ca": 'Spain',
        "hr": 'Croatia',
        "cs": 'Czechia',
        "da": 'Denmark',
        "nl": 'Netherlands',
        "nl-BE": 'Belgium',
        "en-IE": 'Ireland',
        "et": 'Estonia',
        "fi": 'Finland',
        "fr": 'France',
        "fr-BE": 'Belgium',
        "fr-LU": 'Luxembourg',
        "gd-IE": 'Ireland',
        "de": 'Germany',
        "de-AT": 'Austria',
        "de-LU": 'Luxembourg',
        "el": 'Greece',
        "hu": 'Hungary',
        "it": "Italy",
        "lv": "Latvia",
        "lt": "Lithuania",
        "pl": "Poland",
        "pt-BR": "Portugal",
        "pt": "Portugal",
        "ro": "Romania",
        "sk": "Slovakia",
        "sl": "Slovenia",
        "es": "Spain",
        "sv": "Sweden"
      }
      var user_lang = navigator.language || navigator.userLanguage;
      var user_country = iso_lang_country[user_lang] === undefined ? iso_lang_country[user_lang.split("-")[0]] : iso_lang_country[user_lang]
      console.log(user_country)
      console.log(window.screen.width)

      const median = arr => {
        const mid = Math.floor(arr.length / 2),
          nums = [...arr].sort((a, b) => a - b);
        return arr.length % 2 !== 0 ? nums[mid] : (nums[mid - 1] + nums[mid]) / 2;
      };

      //earnings by country (ce)
      var svg_margin = {top: 10, right: 10, bottom: 10, left: 10},
          svg_width = 1600 - svg_margin.left - svg_margin.right,
          svg_height = 800 - svg_margin.top - svg_margin.bottom;

      var top_left_margin = {top: 60, right: 30, bottom: 10, left: 65},
          top_left_width = 600 - top_left_margin.left - top_left_margin.right,
          top_left_height = 600 - top_left_margin.top - top_left_margin.bottom;

      var top_middle_margin = {top: 60, right: 30, bottom: 10, left: 65},
          top_middle_width = 600 - top_middle_margin.left - top_middle_margin.right,
          top_middle_height = 600 - top_middle_margin.top - top_middle_margin.bottom;

      var header_height = 60
      var header_width = 1600

      d3.csv("data/declarations.csv").then(function(data) {
        var deputies = [...new Set(data.map(x => x.deputy_name))];
        var eu_parties = [...new Set(data.map(x => x.eu_party_name))];
        var countries = [...new Set(data.map(x => x.country))];
        var organization_categories = [...new Set(data.map(x => x.organization_category))];

        var deputies_earnings = [];
        deputies.forEach(function(dep){
            var dep_data = data.filter(x => x.deputy_name == dep);
            var country = dep_data[0].country;
            var eu_party =  dep_data[0].eu_party_name;

            var dep_data = dep_data.filter(x => x.remuneration_type != "previous_occupations");
            var occupations_count = dep_data.length
            var paid_occupations_count = dep_data.filter(x => parseInt(x.salary_min) > 0).length;

            var salary_min = dep_data.map(x => parseInt(x.salary_min)).reduce((a, b) => a + b, 0);
            var salary_max = dep_data.map(x => parseInt(x.salary_max)).reduce((a, b) => a + b, 0);

            deputies_earnings.push({
              'deputy_name': dep,
              'country': country,
              'eu_party': eu_party,
              'occupations_count': occupations_count,
              'paid_occupations_count': paid_occupations_count,
              'salary_min': salary_min,
              'salary_max': salary_max
            })
        });

        var country_earnings = [];
        countries.forEach(function(c){
            var country_deputies = deputies_earnings.filter(x => x.country == c);

            var deputies_count = country_deputies.length;
            var deputies_additionally_paid = country_deputies.filter(x => parseInt(x.salary_min) > 0).length;
            var perc_deputies_additionally_paid = deputies_additionally_paid/deputies_count

            var occupations_count = country_deputies.map(x => parseInt(x.occupations_count)).reduce((a, b) => a + b, 0);
            var paid_occupations_count = country_deputies.map(x => parseInt(x.paid_occupations_count)).reduce((a, b) => a + b, 0);

            var avg_salary_min = country_deputies.map(x => parseInt(x.salary_min)).reduce((a, b) => a + b, 0)/deputies_count;
            var avg_salary_max = country_deputies.map(x => parseInt(x.salary_max)).reduce((a, b) => a + b, 0)/deputies_count;

            var median_salary_min = median(country_deputies.filter(x => parseInt(x.salary_min) > 0).map(x => parseInt(x.salary_min)))
            var median_salary_max = median(country_deputies.filter(x => parseInt(x.salary_min) > 0).map(x => parseInt(x.salary_max)))

            country_earnings.push({
              'country': c,
              'deputies_count': deputies_count,
              'deputies_additionally_paid': deputies_additionally_paid,
              'perc_deputies_additionally_paid': perc_deputies_additionally_paid,
              'occupations_count': occupations_count,
              'paid_occupations_count': paid_occupations_count,
              'avg_salary_min': avg_salary_min,
              'avg_salary_max': avg_salary_max,
              'median_salary_min': median_salary_min,
              'median_salary_max': median_salary_max
            })
        });
        country_earnings = country_earnings.sort((a,b) => (a.perc_deputies_additionally_paid < b.perc_deputies_additionally_paid) ? 1 : ((b.perc_deputies_additionally_paid < a.perc_deputies_additionally_paid) ? -1 : 0))

        var div_tooltip = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

        var svg = d3.select("body").append("svg").attr("id","container")
          .attr("width", svg_width + svg_margin.left + svg_margin.right)
          .attr("height", svg_height + svg_margin.top + svg_margin.bottom)


        //##################################
        //header & footer
        //##################################
        var header = svg.append("g").attr("id", 'header')
        header.append("text").attr("class", "title")
          .attr("x", 20)
          .attr("y", 30)
          .style("font-size", "36px").text("MEPs additional monthly income")

        header.append("text").attr("class", "subtitle")
          .attr("x", 20)
          .attr("y", 50)
          .style("font-size", "18px").text("Submitted income declarations, 2019-2021")

        header.append("line")
          .attr("x1", 0).attr("x2", header_width)
          .attr("y1", header_height).attr("y2", header_height)
          .attr("stroke", "#000000").attr("stroke-width", "1px")

        var footer = svg.append("g").attr("id", 'footer')
        footer.append("svg:image").attr("class","logotype")
          .attr("xlink:href", "img/sw_eye.png")
          .attr("x", 20)
          .attr("y", 760)
          .attr("height", 40)
        footer.append("text").attr("class", "subtitle")
          .attr("x", 160)
          .attr("y", 775)
          .style("font-size", "24px").style("font-weight", "bold").text("@sejm_watch")
          footer.append("text").attr("class", "subtitle")
            .attr("x", 165)
            .attr("y", 795)
            .style("font-size", "14px").text("twitter.com/sejm_watch")

        footer.append("line")
          .attr("x1", 0).attr("x2", header_width)
          .attr("y1", 750).attr("y2", 750)
          .attr("stroke", "#000000").attr("stroke-width", "1px")

        //##################################
        //building earnings % by country chart
        //##################################
        var top_left_chart = svg.append("g").attr("id", 'top_left_chart')
            .attr("width", top_left_width + top_left_margin.left + top_left_margin.right)
            .attr("height", top_left_height + top_left_margin.top + top_left_margin.bottom)
          .append("g")
            .attr("transform", "translate(" + top_left_margin.left + "," + (header_height + top_left_margin.top) + ")");

        // Add X axis
        var x = d3.scaleLinear()
          .domain([0, d3.max(country_earnings.map(function(d) {return d.perc_deputies_additionally_paid}))*1.05])
          .range([ 0, top_left_width]);

        // Y axis
        var y = d3.scaleBand()
          .range([ 0, top_left_height ])
          .domain(country_earnings.map(function(d) { return d.country; }))
          .padding(.25);
        top_left_chart.append("g")
          .call(d3.axisLeft(y))

        //bars
        top_left_chart.selectAll("bars")
          .data(country_earnings)
          .enter()
          .append("rect")
          .attr("x", x(0) )
          .attr("y", function(d) { return y(d.country); })
          .attr("width", 0)
          .attr("height", y.bandwidth() )
          .attr("fill", "#003399")
          .on("mouseover", function(event, d) {
            div_tooltip.transition()
              .duration(200)
              .style("opacity", .9);
            div_tooltip.html("<b>" + d.deputies_additionally_paid + "</b> out of <b>" + d.deputies_count + "</b><br/>additionally paid")
              .style("left", (event.pageX) + "px")
              .style("top", (event.pageY - 28) + "px");
            })
          .on("mouseout", function(d) {
            div_tooltip.transition()
              .duration(300)
              .style("opacity", 0);
            });

        top_left_chart.selectAll("rect")
          .transition().delay(0).duration(750)
          .attr("width", function(d) { return x(d.perc_deputies_additionally_paid); })
          .delay(function(d,i){return(i*50)})

        //bar labels
        top_left_chart.selectAll("bar_labels")
          .data(country_earnings)
          .enter()
          .append("text")
          .attr("x", function(d) { return x(d.perc_deputies_additionally_paid) - 25; } )
          .attr("y", function(d) { return y(d.country) + 11.5; })
          .style("font-size", "11px")
          .style('opacity',0).transition().duration(500).style('opacity',1).delay(function(d,i){return(400+i*50)})
          .attr("fill", "#FFFFFF")
          .text(function(d) { return (d.perc_deputies_additionally_paid != 0) ? d3.format(".0%")(d.perc_deputies_additionally_paid) : '';});


          //##################################
          //building earnings median by country chart
          //##################################
          var top_middle_chart = svg.append("g").attr("id", 'top_middle_chart')
              .attr("width", top_middle_width + top_middle_margin.left + top_middle_margin.right)
              .attr("height", top_middle_height + top_middle_margin.top + top_middle_margin.bottom)
            .append("g")
              .attr("transform", "translate(" + (top_middle_margin.left + top_left_width + top_left_margin.left + top_left_margin.right) + "," + (header_height + top_middle_margin.top) + ")");

          // Add X axis
          var x = d3.scaleLinear()
            .domain([0, d3.max(country_earnings.map(function(d) {return d.median_salary_max}))*1.05])
            .range([ 0, top_middle_width]);
          top_middle_chart.append("g")
            .attr("transform", "translate(0," + top_middle_height + ")")
            .call(d3.axisBottom(x)
              .tickFormat(d3.format(".0s"))
            )

          // Y axis
          var y = d3.scaleBand()
            .range([ 0,top_middle_height ])
            .domain(country_earnings.map(function(d) { return d.country; }))
            .padding(1);
          top_middle_chart.append("g")
            .call(d3.axisLeft(y))

          //bars
          top_middle_chart.selectAll("cleveland_lines")
            .data(country_earnings)
            .enter()
            .append("line")
              .attr("x1", function(d) { return x(d.median_salary_min); })
              .attr("x2", function(d) { return x(d.median_salary_min); })
              .attr("y1", function(d) { return y(d.country); })
              .attr("y2", function(d) { return y(d.country); })
              .attr("stroke", "#003399")
              .attr("stroke-width", "2px")
              .transition().delay(0).duration(500)
                .attr("x2", function(d) { return x(d.median_salary_max); }).delay(function(d,i){return(400+i*50)})


          top_middle_chart.selectAll("cleveland_circles")
            .data(country_earnings)
            .enter()
            .append("circle")
              .attr("cx", function(d) { return x(d.median_salary_min); })
              .attr("cy", function(d) { return y(d.country); })
              .attr("r", "6")
              .style("fill", "#FFCC00")
              .style("stroke", "#003399");

          top_middle_chart.selectAll("cleveland_circles")
            .data(country_earnings)
            .enter()
            .append("circle")
              .attr("cx", function(d) { return x(d.median_salary_min); })
              .attr("cy", function(d) { return y(d.country); })
              .attr("r", "6")
              .style("fill", "#6699ff")
              .style("stroke", "#003399")
              .transition().delay(0).duration(500)
                .attr("cx", function(d) { return x(d.median_salary_max); }).delay(function(d,i){return(400+i*50)})

          top_middle_chart.selectAll("cleveland_labels")
            .data(country_earnings)
            .enter()
            .append("text")
            .attr("x", function(d) { return isNaN(d.median_salary_max) ? 0 : x(d.median_salary_max) + 10; } )
            .attr("y", function(d) { return y(d.country) + 4.5; })
            .style("font-size", "11px")
            .style('opacity',0).transition().duration(500).style('opacity',1).delay(function(d,i){return(400+i*50)})
            .attr("fill", "#000000")
            .text(function(d) { return isNaN(d.median_salary_max) ? '' : Math.round(d.median_salary_max/100)/10 + " kEUR"});


      });
    </script>

  </body>
</html>
